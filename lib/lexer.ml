(* ░▓▓██████████████████████▓▓▓▓▓▓███████████████
                ░▓███████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███████████████
                ░▓█▓█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓███████████
                ░▓█▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓██████████
                ░▓█▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▒▓▒▒▒▓▓▓▓▓▓██████████
                ░▒▓▓▓▒▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▓▓▓▓█████████
                ▒▓▓▓▓▓▓▓▓▓▓▒▒▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▓▓▓█████████
               ▒▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▒▒▒▒▒▓▓▓▓▓▓██████████
              ▒▓▓▓██▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓██████████
            ░▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒░░░░░░░░░░░░░░░░░▒▒▒▓▓█████████
            ▒▓▒▒▓▓▓▓▒▒▒▒▒▒▒░░░░░░              ░░░░▓▓▓████████
           ░▓▒▒▒▒▒▒▒▒░░░░░░░░                      ░▒▓▓█████▓█
           ▒▒▒▒▒▒▒▒▒░░░░░░░                         ░▓▓▓▓█▓▓▓▓
           ▒▒▒▒▒▒▒▒▒░░░░░░                        ░░░░░▒▓▓█▓▓▓
          ░▒▓▒▒▒▒▒▒▒▒░░░░░                        ░░░░░░▓█▓▓▓▓
          ░▓▓▒▓▒▒▒▒▒▒▒░░░                   ░░░░░░░░░░▒░▒▓▓▓▓▓
          ▒▓▓▓▓▒▒▒▒▒▒░░░ ░░░              ░░░ ░░░░░░░░▒▒▒▓▓▓▓▓
          ▒▓▓▓▓▓▒▒▒▒▒░░░    ░░░░       ░░░░░░░░  ░░░░░▒▓▓▓████
          ░▓▓▓▓▒▒▒▒▒▒▒░░░░▒▒░░░░░░   ░░▒▒▒▓▒▒▒▒░░░░░░▒▒▓▓█████
           ▒▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▒░░   ░░▒▒▒▒▒░░░░░░ ░░▒▒▒▓█████
           ░▓▓▓▒▒▒▒▒▒▒▒▒▒░░░░░▒▒░      ░░░░░░░      ░▒░░▓█████
           ░▓▓▓▓▒▒▒░▒░░░     ░░░                   ░░▒  ▓█████
           ░▒▓▓▓▒▒▒▒░░░░     ░░░░                  ░░░ ░██████
            ▒▓▓▓▓▒▒▒▒▒░░░    ░▒░                   ░░  ▒██████
            ░▒▓▓▓▓▒▒▒▒▒░░   ░░▒░░                 ░░░  ▒██████
             ▒▓▓▓▓▓▒▒▒▒▒░░░ ░▒▓▓▒▒░░▒▒▒          ░░▒░ ░███████
              ░▒▓▓▓▓▒▒▒▒░░░ ░▒▒▓▓▓▒▒▒░         ░░░░▒▒▒▓███████
               ▒▓▓▓▓▓▒▒▒░░░░░▒▒▒░▒▒▒▒░░        ░░░▒▓▓█████████
               ▒▒▓▓▓▓▓▓▒▒░░░▒▒▒▒░░▒▒▒░░░░    ░░░░▒▓▓██████████
               ▒▓▓▓▓▓▓▓▓▒▒▒▒▓▓▓▓▓▓▓▒▒░░░░░░░░░░▒▒▒▓▓██████████
              ░▒▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒███▓▒▒▒▒▒░░░░▒▒▒▒▓▓▓██████████
           ▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒░░▒▒▒▒░░░▒▒▒░░▒▒▓▓▓▓░░░▓████████
        ░░▒▒▒▒▓▓▓▓▓███▓▓▓▒▒▒▒▓▒░░░░░░░░░▒░░▒▒▓▓▓▓▓▒░   ░▒▒▓███
   ░░░░▒▒▒▓▓▓▓▒▒▒▓▓██▓▓▓▓▓▓▒▒▒▓▓▒▒▒▒▒░░░▒▒▒▒▓▓▓▓▓▓▒          ▒
   ░░░░░▒▒▓▓▓▓▓▒▒█▓███▓▓▓▓▓▒▒▒▒▒▒▒▒░░░░▒▒▒▒▓▓▓▓▓▓▒      ░░
      ░░░▒▒▓▓▓▒▒▒▓▓▓▓▓▓█▓▓▓▓▒▒▒▒▒▒░░░░░▒▒▒▓▓▓▓▓▓▒░
      ░░░░▒▒▓▓▒▒▓▓▓▓▓▓▓██▓▓▓▓▒▒▒▒▒░░░░▒▒▓▓▓▓▓▓▓▒     ░░░░ ░░
     ░░░▒▒▒▒▓▓▒▒▓▓▓▓▓▓▓███▓▓▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓░        ░░░ ░░░
        ░░░░▒▓▒▒▒▓▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░            ░░░
           ░░▒▒▒▒▓▓▓▓▓▓▓▓███████████████▓▓▒▒░░               ░
           ░░▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓████████▓▓▓▓▒░░░░             ░░
         ░░▒▒░▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒░░░░░░         ░░░░▒░
     ░░░░░░░░▒░▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒░░░░░░░░    ░░░░░    ░ *)

open Prelude
open Span

type token = Ident of string
type position_with_index = { pos : pos; index : int }

let show : token spanned -> string =
 fun spanned ->
  let (Ident ident) = spanned.value in
  ident

let parse : string -> filename -> token spanned Seq.t =
 fun contents file ->
  let content_len = String.length contents in
  let index = ref 0 in
  let position = ref { line = 0; column = 0 } in
  let peek : unit -> char option =
   fun () ->
    if !index < content_len then Some (String.get contents !index) else None
  in
  let next : unit -> char option =
   fun () ->
    let c = peek () in
    (match c with Some _ -> index := !index + 1 | _ -> ());
    position := { !position with column = !position.column + 1 };
    (match c with
    | Some '\n' -> position := { line = !position.line + 1; column = 0 }
    | _ -> ());
    c
  in
  let current_token_start : position_with_index option ref = ref None in
  let single_char_tokens = "()[]{}+-*/,;" in
  let should_start_new_token () =
    match peek () with Some c -> not (is_space c) | None -> false
  in
  let should_split () =
    match peek () with
    | Some c -> (
        match !current_token_start with
        | None -> should_start_new_token ()
        | Some start -> (
            let prev = String.get contents (!index - 1) in
            match String.get contents start.index with
            | '"' -> start.index + 1 != !index && prev = '"'
            | _ ->
                Option.is_some (String.index_opt single_char_tokens prev)
                || Option.is_some (String.index_opt single_char_tokens c)))
    | None -> true
  in
  let go () =
    (* print_endline *)
    (*   (match peek () with *)
    (*   | Some c -> "parsing char \"" ^ String.make 1 c ^ "\"" *)
    (*   | None -> "parsing eof"); *)
    let result =
      if should_split () then (
        let prev_token =
          Option.map
            (fun start ->
              {
                value =
                  Ident (String.sub contents start.index (!index - start.index));
                span = { start = start.pos; finish = !position; file };
              })
            !current_token_start
        in
        (* print_endline *)
        (*   (match prev_token with Some _ -> "some" | None -> "none"); *)
        current_token_start := None;
        if should_start_new_token () then (
          current_token_start := Some { pos = !position; index = !index };
          Some prev_token)
        else Option.map (fun x -> Some x) prev_token)
      else Some None
    in
    let _ = next () in
    result
  in
  Seq.filter_map (fun x -> x) (Seq.of_dispenser go)
